<!DOCTYPE html>

<html>
  <head>
    <title>HackerNews - Who I've Applied To</title>
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios@0.12.0/dist/axios.min.js"></script>
    <script src="https://unpkg.com/lodash@4.13.1/lodash.min.js"></script>
  </head>

  <body>
    <p>This is a little toy app to keep track of which companies you've applied to on HackerNews's "Who Is Hiring?" posts.</p>
    <div id="hn">
      <job-post v-for="id in jobPostIds" :comment-id="id"></job-post>
    </div>
  </body>

  <script>
    var userUrl = function(username) {
      return 'https://news.ycombinator.com/user?id=' + username
    }

    var itemUrl = function(itemId) {
      return 'https://news.ycombinator.com/item?id=' + itemId
    }

    var itemApiUrl = function(itemId) {
      return 'https://hacker-news.firebaseio.com/v0/item/' + itemId + '.json'
    }

    var UserLink = {
      props: ['username'],
      template: '<a :href="userUrl">{{ username }}</a>',
      computed: {
        userUrl() {return userUrl(this.username)}
      }
    }

    var PermaLink = {
      props: ['itemId', 'time'],
      template: '<a :href="itemUrl">{{ time }}</a>',
      computed: {
        itemUrl() {return itemUrl(this.itemId)}
      }
    }

    var JobPost = {
      data: () => {
        return {
          by: '',
          id: '',
          time: '',
          text: ''
        }
      },
      props: {
        commentId: {
          required: true
        }
      },
      components: {
        'userlink': UserLink,
        'permalink': PermaLink
      },
      template: `
        <div>
          <p><userlink :username="by"></userlink> - <permalink :id="id" :time="time"></permalink></p>
          <p v-html="text"></p>
        </div>
      `,
      mounted() {
        var jobPost = this;
        axios.get(itemApiUrl(this.commentId))
          .then(function (response) {
            jobPost.by = response.data.by
            jobPost.id = response.data.id
            jobPost.time = response.data.time
            jobPost.text = response.data.text
          })
          .catch(function (error) {
            console.log('Something went wrong fetching the job post.')
          })
      }
    };

    var whoIsHiring = new Vue({
      el: '#hn',
      data: {
        jobPostIds: [],
        postUrl: itemApiUrl(13301832)
      },
      components: {
        'job-post': JobPost
      },
      mounted() {
        var rootApp = this;
        axios.get(this.postUrl)
          .then(function (response) {
            rootApp.jobPostIds = response.data.kids;
          })
          .catch(function (error) {
            console.log('Something else went wrong fetching the who is hiring post.')
          })
      }
    });
  </script>
</html>
