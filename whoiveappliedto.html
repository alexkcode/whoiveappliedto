<!DOCTYPE html>

<html>
  <head>
    <title>HackerNews - Who I've Applied To</title>
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios@0.12.0/dist/axios.min.js"></script>
    <script src="https://unpkg.com/lodash@4.13.1/lodash.min.js"></script>
  </head>

  <body>
    <p>This is a little toy app to keep track of which companies you've applied to on HackerNews's "Who Is Hiring?" posts.</p>
    <div id="hn">
      <job-post v-for="job in jobPosts" :by="job.by" :id="job.id" :time="job.time" :text="job.text"></job-post>
    </div>
  </body>

  <script>
    var userUrl = function(username) {
      return 'https://news.ycombinator.com/user?id=' + username
    }

    var itemUrl = function(itemId) {
      return 'https://news.ycombinator.com/item?id=' + itemId
    }

    var itemApiUrl = function(itemId) {
      return 'https://hacker-news.firebaseio.com/v0/item/' + itemId + '.json'
    }

    var UserLink = {
      props: ['username'],
      template: '<a :href="userUrl">{{ username }}</a>',
      computed: {
        userUrl() {return userUrl(this.username)}
      }
    }

    var PermaLink = {
      props: ['itemId', 'time'],
      template: '<a :href="itemUrl">{{ time }}</a>',
      computed: {
        itemUrl() {return itemUrl(this.itemId)}
      }
    }

    var JobPost = {
      props: ['by', 'id', 'time', 'text'],
      components: {
        'userlink': UserLink,
        'permalink': PermaLink
      },
      template: `
        <div>
          <p><userlink :username="by"></userlink> - <permalink :id="id" :time="time"></permalink></p>
          <p v-html="text"></p>
        </div>
      `
    };

    var whoIsHiring = new Vue({
      el: '#hn',
      data: {
        jobPostIds: [],
        jobPosts: [],
        hiringMonthId: 13301832
      },
      components: {
        'job-post': JobPost
      },
      methods: {
        getCachedPost(postId) {
          var cachedPost = localStorage.getItem(postId)

          if (cachedPost === undefined || cachedPost ===null) {return cachedPost}

          if (cachedPost.length > 0) {
            return JSON.parse(cachedPost)
          } else {
            return null
          }
        },
        setCachedPost(postId, obj) {
          localStorage.setItem(postId, JSON.stringify(obj))
        }

      },
      mounted() {
        var rootApp = this;
        axios.get(itemApiUrl(this.hiringMonthId))
          .then(function (response) {
            rootApp.jobPostIds = response.data.kids;
            rootApp.jobPostIds.forEach((postId)=>{
              var cachedPost = rootApp.getCachedPost(postId)
              if (cachedPost) {
                rootApp.jobPosts.push(cachedPost)
              } else {
                axios.get(itemApiUrl(postId))
                  .then(function (response) {
                    rootApp.jobPosts.push(response.data)
                    rootApp.setCachedPost(postId, response.data)
                  })
                  .catch(function (error) {
                    console.log('Something went wrong fetching the job post.')
                  })
              }

            });
          })
          .catch(function (error) {
            console.log('Something else went wrong fetching the who is hiring post.')
          })
      }
    });
  </script>
</html>
